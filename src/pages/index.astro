---
import Headline from "../components/Headline.astro";
import DefaultLayout from "../layouts/DefaultLayout.astro";
import Separator from "../components/Separator.astro";
import CopyServerAddressButton from "../components/CopyServerAddressButton.astro";

//@ts-ignore
import TextLogo from "../assets/largehero.png?format=webp&w=1000";

import DirtTexture from "../assets/images/textures/dirt.png";
import PlayButtonTexture from "../assets/images/textures/play.png";
import PlayButtonHoverTexture from "../assets/images/textures/play_hover.png";
import Click from "../assets/audio/click.ogg"
//@ts-ignore
import Screenshot from "../assets/screenshot1.png?format=webp&w=800";

import { LINKS } from "../config";

//@ts-ignore
import ImageDuels from "../assets/images/gamemodes/1v1.png?format=webp&w=800";
//@ts-ignore
import ImageFFA from "../assets/images/gamemodes/FFA.png?format=webp&w=800";
//@ts-ignore
import ImageFireball from "../assets/images/gamemodes/fireball.png?format=webp&w=800";
//@ts-ignore
import ImageTNTTag from "../assets/images/gamemodes/tnttag.png?format=webp&w=800";

import Pronounciation from "../assets/audio/baggel.mp3"
import SecretPronounciation from "../assets/audio/baggel_remix.mp3"

const finishedGames = [
  {
    name: "Duels 1v1",
    description:
      "Tritt gegen einen anderen Spieler in intensiven, schnellen PvP-Duellen an. Wähle dein Kit, schärfe deine Reflexe und kämpfe um den Sieg in unseren Arenen! Nur die Besten werden bestehen.",
    image: ImageDuels,
  },
  {
    name: "Knockback FFA",
    description:
      "Keine Teams, keine Gnade! Jeder Spieler für sich selbst! Springe in chaotische Free-for-All-Kämpfe, bei denen schnelles Denken und Geschick entscheiden, wer das Schlachtfeld dominiert.",
    image: ImageFFA,
  },
  {
    name: "Fireball Fight",
    description:
      "Schieße, weiche aus und kämpfe dich mit Explosionen zum Sieg! Nutze Präzision und Timing, um deine Gegner mit gut gezielten Feuerbällen von der Karte zu befördern. Ein Treffer kann alles ändern.",
    image: ImageFireball,
  },
  {
    name: "Hot Potato",
    description:
      "Du hast eine tickende Zeitbombe! Gib sie schnell weiter, bevor sie explodiert! Wer am Ende die Bombe hat, verliert. Geschwindigkeit und Strategie entscheiden über Sieg oder Niederlage.",
    image: ImageTNTTag,
  },
];

const unfinishedGames = [
  {
    name: "Pillars of Fortune",
    description:
      "Du bist auf einer winzigen Säule gestrandet, die im Nichts schwebt. Alle paar Sekunden gibt dir das Schicksal zufällige Gegenstände, manchmal hilfreich, manchmal tödlich. Überlebe alle anderen in diesem Spiel aus purem Chaos und Glück!",
  },
  {
    name: "Chess",
    description:
      "Das klassische Strategiespiel im Minecraft-Stil. Bewege deine Armee über das Brett, plane jeden Angriff und setze deinen Gegner schachmatt!",
  },
  {
    name: "TNT Run",
    description:
      "Beweg dich oder falle! Der Boden verschwindet unter deinen Füßen, während du rennst. Ein falscher Schritt und das Spiel ist vorbei. Überlebe alle anderen in diesem explosiven Test für Reflexe und Kontrolle.",
  },
  {
    name: "Baggel Clicker",
    description:
      "Jeder Klick zählt! Sammle Münzen, kaufe Upgrades und klettere die Bestenliste hinauf in diesem süchtig machenden Idle-Clicker-Erlebnis, inspiriert von Cookie Clicker, aber mit diesem Baggel-Flair.",
  },
  {
    name: "Replica",
    description:
      "Pass genau auf! Eine Struktur erscheint und es liegt an dir, sie perfekt nachzubauen. Geschwindigkeit und Präzision entscheiden, wer als Meisterbauer herrscht.",
  },
  {
    name: "SpeedCrafter",
    description:
      "Bastele oder werde gebastelt! Rase darum, zufällige Rezepte so schnell wie möglich zu vervollständigen. Je schneller deine Hände und dein Gedächtnis, desto höher deine Punktzahl und dein Recht zu prahlen.",
  },
  {
    name: "Cow Pong",
    description:
      "Klassisches Pong... aber mit Kühen! Schnell zu sein ist der Schlüssel! (Ich schwöre, die Kühe mögen es!)",
  },
];
---

<DefaultLayout>

  <div class="max-w-5xl mx-auto px-4 sm:px-8 py-16 sm:py-20 text-text font-sans space-y-20">

    
    <img src={TextLogo} class="mx-auto h-30 md:h-80 object-cover" alt="Baggel Logo" />


    <!-- Server Info Section -->
    <section 
      class="info-section bg-background-10 relative max-w-xl mx-auto text-left text-text rounded-4xl shadow-lg border border-background-50 hover:border-accent transition-all duration-500 overflow-hidden"
    >
      <div class="absolute inset-0 h-67 overflow-hidden">
        <img
          src={Screenshot}
          alt="Server Screenshot"
          class="blur-xs w-full scale-105 h-full object-cover object-center opacity-40 group-hover:opacity-50 transition-opacity duration-500"
        />
      </div>

      <!-- Content Overlay -->
      <div class="relative z-10 px-6 sm:px-8 md:px-10 py-10 text-center space-y-4 bg-transparent">
        <h2 class="text-xl sm:text-2xl font-bold tracking-wide text-primary text-center">Server-Status</h2>

        <ul class="space-y-2 text-base">
          <li>
            <strong>Status:</strong> 
            <span id="server-status" class="text-neutral-400">Lädt...</span>
          </li>
          <li>
            <strong>Spieler:</strong>
            <span id="server-players" class="text-neutral-400">0 / 0</span>
          </li>
        </ul>

        <div class="mt-4 text-center hidden md:block">
          <div
            class="motd-box mt-2 items-center gap-4 font-minecraft text-xs group inline-flex"
            style={`background-image: url('${DirtTexture.src}');`}
          >
            <div class="icon-container relative w-16 h-16 shrink-0 hidden" id="serverIconContainer">
              <img id="server-icon" alt="Server Icon" class="icon-image w-full h-full object-cover" />
              <img
                src={PlayButtonTexture.src}
                alt="Play Button Overlay"
                class="icon-overlay absolute inset-0 w-full h-full object-cover"
              />
              <img
                src={PlayButtonHoverTexture.src}
                alt="Play Button Hover Overlay"
                class="icon-overlay-hover absolute inset-0 w-full h-full object-cover opacity-0 group-hover:opacity-100"
              />
              <audio id="clickAudio" src={Click}></audio>
            </div>

            <span id="server-motd" class="text-text-50">Lädt MOTD...</span>
          </div>
        </div>

        <div class="mt-4 flex justify-center">
          <CopyServerAddressButton text="Kopiere Server-Adresse" copyText={LINKS.server_address} />
        </div>
      </div>
    </section>


    <section class="definition-section max-w-xl mx-auto px-6 sm:px-8 md:px-10 text-left text-text rounded-4xl bg-linear-to-br from-background-10 to-background-10 border border-background-50 hover:border-accent transition-all duration-500 shadow-lg hover:shadow-2xl py-5">
      <div class="flex items-center gap-4">
        <h2 class="text-xl sm:text-2xl font-bold italic tracking-wide text-primary mb-4">
          Ba·ggel
        </h2>
        <button
          id="playAudioButton"
          class="audio-button text-text-50 hover:text-primary transition-all duration-300"
          aria-label="Play pronunciation"
        >
          <svg
            id="speakerIcon"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 32 32"
            class="w-10 h-10 sm:w-15 sm:h-15"
          >
            <path xmlns="http://www.w3.org/2000/svg" d="M20.4,2.9c-0.3-0.2-0.7-0.1-1,0.1L9.7,10H3c-0.6,0-1,0.4-1,1v10c0,0.6,0.4,1,1,1h6.7l9.7,7.1c0.2,0.1,0.4,0.2,0.6,0.2   c0.2,0,0.3,0,0.5-0.1c0.3-0.2,0.5-0.5,0.5-0.9V3.8C21,3.4,20.8,3,20.4,2.9z"/>
            <path xmlns="http://www.w3.org/2000/svg" d="M27.1,9.3c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4C27.2,12.1,28,14,28,16s-0.8,3.9-2.3,5.3c-0.4,0.4-0.4,1,0,1.4   c0.2,0.2,0.5,0.3,0.7,0.3c0.2,0,0.5-0.1,0.7-0.3C29,20.9,30,18.6,30,16S29,11.1,27.1,9.3z"/>
            <path xmlns="http://www.w3.org/2000/svg" d="M24.7,12.7c-0.4-0.4-1-0.4-1.4,0.1c-0.4,0.4-0.3,1,0.1,1.4c0.5,0.5,0.8,1.2,0.8,1.9s-0.3,1.4-0.8,1.9   c-0.4,0.4-0.4,1-0.1,1.4c0.2,0.2,0.5,0.3,0.7,0.3c0.2,0,0.5-0.1,0.7-0.3c1-0.9,1.5-2.1,1.5-3.3S25.6,13.5,24.7,12.7z"/>
          </svg>
        </button>
      </div>

      <p class="text-text-50 text-lg italic mb-2">nomen</p>
      <p class="text-text-100 text-base mb-4">/ˈbeɪɡl̩/</p>
      <p class="text-lg text-text-50">
        eine <span class="text-accent">Minecraft server community</span>
      </p>

      <audio id="pronunciationAudio" src={Pronounciation}></audio>
      <audio id="secretPronunciationAudio" src={SecretPronounciation}></audio>
    </section>

    <!-- Finished Games Section -->
    <section class="finished-games text-center">
      <h2 class="text-2xl font-bold mb-8 text-primary">Verfügbare Spiele</h2>

      <div class="flex flex-wrap justify-center gap-8">
        {finishedGames.map((game) => (
          <div class="w-full sm:w-[45%] lg:w-[45%] max-w-xl group relative rounded-2xl overflow-hidden bg-background-10 border border-background-50 hover:border-accent transition-all duration-500 shadow-lg hover:shadow-2xl">
            <img
              src={game.image}
              alt={game.name}
              class="w-full h-48 object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-500"
            />
            <div class="p-6 text-left space-y-2">
              <h3 class="text-xl font-bold text-primary">{game.name}</h3>
              <p class="text-text-50">{game.description}</p>
            </div>
          </div>
        ))}
      </div>
    </section>

    <Separator/>

    <!-- Coming Soon Section -->
    <section class="unfinished-games text-center">
      <h2 class="text-2xl font-bold mb-8 text-primary">Demnächst</h2>

      <div class="flex flex-wrap justify-center gap-8">
        {unfinishedGames.map((game) => (
          <div class="w-full sm:w-[45%] lg:w-[45%] max-w-xl group relative rounded-2xl overflow-hidden bg-background-10 border border-background-50 hover:border-accent transition-all duration-500 shadow-lg hover:shadow-2xl">
            <div class="absolute bottom-4 right-4 bg-accent/20 text-accent text-xs font-semibold px-2 py-1 rounded-md backdrop-blur-sm border border-accent/30">
              In Entwicklung
            </div>

            <div class="p-6 text-left space-y-2 mb-8">
              <h3 class="text-xl font-bold text-primary">{game.name}</h3>
              <p class="text-text-50">{game.description}</p>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Development Notice -->
    <section class="text-center max-w-2xl mx-auto">
      <Separator/>
      <p class="text-text-50 text-base">
        Unser Server befindet sich derzeit in <span class="text-accent font-semibold">aktiver Entwicklung</span>.<br />
        Neue Spielmodi und Funktionen werden ständig hinzugefügt. Bleib dran!
      </p>
    </section>

  </div>

</DefaultLayout>

<style>
.motd-box {
  position: relative;
  background-repeat: repeat;
  background-size: 64px 64px;
  image-rendering: pixelated;
  border: 2px solid #fff;
  padding: 1rem;
  display: inline-flex;
  align-items: center;
  justify-content: flex-start;
  line-height: 1.5;
  overflow: hidden;
  z-index: 0;
}

.motd-box::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.75);
  pointer-events: none;
  z-index: 1;
}

.motd-box > * {
  position: relative;
  z-index: 2;
}

.icon-container {
  position: relative;
  width: 64px;
  height: 64px;
  overflow: hidden;
  image-rendering: pixelated;
  cursor: pointer;
}

/* White overlay */
.icon-container::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.25);
  opacity: 0;
  z-index: 1;
}

/* Overlay hover */
.group:hover .icon-container::before {
  opacity: 1;
}

/* Base icon */
.icon-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  image-rendering: pixelated;
  image-rendering: crisp-edges;
  position: relative;
  z-index: 0;
}

/* Overlay textures */
.icon-overlay,
.icon-overlay-hover {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  pointer-events: none;
  z-index: 2; /* above white overlay */
}

.icon-overlay {
  opacity: 0;
}

.icon-overlay-hover {
  opacity: 0;
}

/* Show play texture */
.group:hover .icon-overlay {
  opacity: 1;
}

/* Swap texture */
.group:hover .icon-container:hover .icon-overlay {
  opacity: 0;
}
.group:hover .icon-container:hover .icon-overlay-hover {
  opacity: 1;
}

.definition-section {
  padding-left: var(--space-6);
  margin-top: var(--space-16);
}

.definition-section h2 {
  font-family: var(--font-minecraft);
  line-height: var(--leading-3xl);
}

.definition-section p {
  margin-bottom: var(--space-3);
}

.audio-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  cursor: pointer;
  padding: var(--space-2);
  border-radius: var(--space-2);
}

.audio-button:hover {
  color: var(--color-primary);
  transform: scale(1.1);
}

.audio-button:active {
  transform: scale(0.95);
}

@keyframes hueRotate {
  from { filter: hue-rotate(0deg); }
  to { filter: hue-rotate(360deg); }
}

.hue-shift {
  animation: hueRotate 1s linear infinite;
}

.hue-shift * {
  animation: hueRotate 1s linear infinite;
}


</style>

<script>
  const serverIcon = document.getElementById("serverIcon") as HTMLButtonElement | null;

  const audio = document.getElementById("clickAudio") as HTMLAudioElement | null;

  if (audio && serverIcon) {
    audio.volume = 0.3
    serverIcon.addEventListener("click", () => {audio.play()});
  }

</script>

<script>
  const chance = 0.1;
  const rotationSpeed = 360; // degrees per second
  const volume = 0.25;
  const minClicksForSecret = 3;

  document.addEventListener("DOMContentLoaded", () => {
    const playButton = document.getElementById("playAudioButton") as HTMLButtonElement | null;
    const normalAudio = document.getElementById("pronunciationAudio") as HTMLAudioElement | null;
    const secretAudio = document.getElementById("secretPronunciationAudio") as HTMLAudioElement | null;

    if (!playButton || !normalAudio || !secretAudio) return;

    normalAudio.volume = volume;
    secretAudio.volume = volume;

    let animationFrameId: number | null = null;
    let hue = 0;
    let activeAudio: HTMLAudioElement | null = null;
    let clickCount = 0;
    let lastFrameTime: number | null = null;

    // List of CSS variables to rotate
    const colorVars = [
      "--color-text",
      "--color-text-50",
      "--color-text-100",
      "--color-background",
      "--color-background-gradient",
      "--color-background-10",
      "--color-background-50",
      "--color-background-100",
      "--color-primary",
      "--color-secondary",
      "--color-accent",
      "--color-success",
      "--color-success-gradient",
      "--color-error",
      "--color-error-gradient",
    ];

    // Convert hex to HSL
    const hexToHSL = (hex: string) => {
      hex = hex.replace("#", "");
      const r = parseInt(hex.substring(0, 2), 16) / 255;
      const g = parseInt(hex.substring(2, 4), 16) / 255;
      const b = parseInt(hex.substring(4, 6), 16) / 255;

      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h = 0, s = 0, l = (max + min) / 2;

      if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h *= 60;
      }

      return { h, s, l };
    };

    // Convert HSL back to hex
    const hslToHex = ({h, s, l}: {h:number,s:number,l:number}) => {
      const c = (1 - Math.abs(2*l - 1)) * s;
      const x = c * (1 - Math.abs((h/60)%2 - 1));
      const m = l - c/2;
      let r=0,g=0,b=0;
      if (h>=0 && h<60) { r=c; g=x; b=0 }
      else if (h<120) { r=x; g=c; b=0 }
      else if (h<180) { r=0; g=c; b=x }
      else if (h<240) { r=0; g=x; b=c }
      else if (h<300) { r=x; g=0; b=c }
      else { r=c; g=0; b=x }

      const toHex = (v:number) =>
        Math.round((v+m)*255).toString(16).padStart(2,"0");

      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    };

    // Store original colors
    const originalColors = colorVars.map(v =>
      getComputedStyle(document.documentElement).getPropertyValue(v).trim() || "#000000"
    );

    const updateColors = (currentTime: number) => {
      if (lastFrameTime === null) {
        lastFrameTime = currentTime;
      }

      const deltaTime = (currentTime - lastFrameTime) / 1000; // Convert to seconds
      lastFrameTime = currentTime;

      hue = (hue + rotationSpeed * deltaTime) % 360;
      colorVars.forEach((v, i) => {
        const hsl = hexToHSL(originalColors[i]);
        hsl.h = (hsl.h + hue) % 360;
        document.documentElement.style.setProperty(v, hslToHex(hsl));
      });
      animationFrameId = requestAnimationFrame(updateColors);
    };

    const startPartyMode = () => {
      if (!animationFrameId) {
        lastFrameTime = null;
        animationFrameId = requestAnimationFrame(updateColors);
      }
    };

    const stopPartyMode = () => {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
      lastFrameTime = null;

      colorVars.forEach((v, i) =>
        document.documentElement.style.setProperty(v, originalColors[i])
      );
    };

    secretAudio.addEventListener("ended", stopPartyMode);
    normalAudio.addEventListener("ended", stopPartyMode);

    playButton.addEventListener("click", () => {
      clickCount++;
      
      // Only allow secret audio if user has clicked at least 3 times
      const canTriggerSecret = clickCount >= minClicksForSecret;
      const isSecret = canTriggerSecret && Math.random() < chance;

      if (activeAudio) {
        activeAudio.pause();
        activeAudio.currentTime = 0;
      }

      activeAudio = isSecret ? secretAudio : normalAudio;

      activeAudio.currentTime = 0;
      activeAudio.play();

      if (isSecret) startPartyMode();
      else stopPartyMode();
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const SERVER_ADDRESS = "baggel.de";
    const API_URL = `https://api.mcsrvstat.us/3/${SERVER_ADDRESS}`;

    const statusEl = document.getElementById("server-status");
    const playersEl = document.getElementById("server-players");
    const motdEl = document.getElementById("server-motd");
    const iconContainer = document.getElementById("serverIconContainer");
    const iconImg = document.getElementById("server-icon");
    const clickAudio = document.getElementById("clickAudio");

    if (!statusEl || !playersEl || !motdEl) {
      console.warn("Server status elements not found in DOM.");
      return;
    }

    statusEl.textContent = "Lädt...";
    statusEl.className = "text-neutral-400";

    try {
      const res = await fetch(API_URL);

      if (!res.ok) {
        throw new Error(`HTTP error ${res.status}`);
      }

      const data = await res.json();

      // Status
      if (data.online) {
        statusEl.textContent = "Online";
        statusEl.className = "text-success";
        playersEl.textContent = `${data.players?.online ?? 0} / ${data.players?.max ?? 0}`;
      } else {
        statusEl.textContent = "Offline";
        statusEl.className = "text-error";
        playersEl.textContent = "-";
      }

      // MOTD
      if (data.motd?.html && Array.isArray(data.motd.html)) {
        motdEl.innerHTML = data.motd.html.join("<br>");
      } else {
        motdEl.textContent = "Kein MOTD verfügbar.";
      }

      // Icon
      if (data.icon && iconContainer && iconImg) {
        iconContainer.classList.remove("hidden");
        iconImg.setAttribute("src", data.icon);

        if (clickAudio instanceof HTMLAudioElement) {
          iconContainer.addEventListener("click", () => {
            clickAudio.volume = 0.3;
            clickAudio.play().catch(() => {});
          });
        }
      } else if (iconContainer) {
        iconContainer.classList.add("hidden");
      }
    } catch (err) {
      console.error("Error fetching server info:", err);
      statusEl.textContent = "Fehler";
      statusEl.className = "text-error";
      playersEl.textContent = "-";
      motdEl.textContent = "Server-Informationen konnten nicht geladen werden.";
    }
  });
</script>
