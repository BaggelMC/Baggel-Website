---
// @ts-ignore
import logoSrc from "../assets/logo.png?format=webp&w=64&h=64";
// @ts-ignore
import texture from "../assets/header-texture.png?format=webp&h=200"
---

<header
  class="relative text-text shadow-lg"
>
  <div
    class="relative"
    style={`background-image: url(${texture}); background-size: cover; background-position: center; image-rendering: pixelated;`}
  >

    <div class="absolute inset-0 bg-linear-to-r from-primary/20 to-accent/20 pointer-events-none"></div>

    <div class="max-w-6xl mx-auto flex justify-between items-center p-(--space-4)">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 text-lg font-bold font-minecraft z-2">
        <img src={logoSrc} alt="Logo" class="h-[2em] w-auto" />
        Baggel
        <!-- <img src={NewTitle} alt="Logo" class="h-[2em] w-auto hidden md:block" /> -->
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:block">
        <ul class="flex space-x-6 items-center relative">
          <li><a href="/" class="hover:text-accent transition">Home</a></li>

          <!-- Projects Dropdown -->
          <li class="dropdown relative group">
            <button 
              class="hover:text-accent transition flex items-center gap-1"
              aria-expanded="false"
              aria-haspopup="true"
              aria-controls="projects-dropdown"
              id="projects-button"
            >
              Projekte
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <ul 
              id="projects-dropdown"
              class="dropdown-menu z-9999 absolute left-0 mt-2 rounded-2xl opacity-0 -translate-y-2 pointer-events-none transition-all duration-200 ease-in-out
              p-px bg-linear-to-br from-background via-accent to-background group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto"
              role="menu"
              aria-labelledby="projects-button"
            >
              <div class="bg-background rounded-[inherit] overflow-hidden">
                <li role="none"><a href="/projects/buildmc" class="block px-4 py-2 hover:bg-accent-light hover:text-accent transition" role="menuitem">BuildMC</a></li>
              </div>
            </ul>
          </li>

          <!-- Plugins Dropdown -->
          <li class="dropdown relative group">
            <button 
              class="hover:text-accent transition flex items-center gap-1"
              aria-expanded="false"
              aria-haspopup="true"
              aria-controls="plugins-dropdown"
              id="plugins-button"
            >
              Plugins
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <ul 
              id="plugins-dropdown"
              class="dropdown-menu absolute left-0 mt-2 rounded-2xl opacity-0 -translate-y-2 pointer-events-none transition-all duration-200 ease-in-out
              p-px bg-linear-to-br from-background via-accent to-background group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto"
              role="menu"
              aria-labelledby="plugins-button"
            >
              <div class="bg-background rounded-[inherit]">
                <li role="none"><a href="/plugins/de/core" class="block px-4 py-2 hover:bg-accent-light hover:text-accent transition" role="menuitem">Core</a></li>
              </div>
            </ul>
          </li>

          <!-- Static Pages -->
          <li><a href="/gallery" class="hover:text-accent transition">Gallerie</a></li>
          <li><a href="/team" class="hover:text-accent transition">Team</a></li>
        </ul>
      </nav>

      <!-- Mobile Menu Button -->
      <button 
        id="mobile-menu-toggle" 
        class="md:hidden flex flex-col gap-1 p-2 hover:text-accent transition"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Toggle mobile menu"
      >
        <span class="block w-6 h-0.5 bg-current"></span>
        <span class="block w-6 h-0.5 bg-current"></span>
        <span class="block w-6 h-0.5 bg-current"></span>
      </button>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <nav id="mobile-menu" class="md:hidden max-h-0 overflow-hidden transition-all duration-300 ease-in-out bg-background/95 backdrop-blur-md" aria-labelledby="mobile-menu-toggle">
    <ul class="flex flex-col p-4 space-y-2 border-t border-background-50">
      <li><a href="/" class="block py-2 hover:text-accent transition">Home</a></li>

      <!-- Projects -->
      <li>
        <button 
          class="w-full text-left flex justify-between items-center py-2 hover:text-accent transition" 
          data-toggle="projects"
          aria-expanded="false"
          aria-haspopup="true"
          aria-controls="projects"
          id="mobile-projects-button"
        >
          Projekte
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <ul class="hidden pl-4 space-y-1" id="projects" role="menu" aria-labelledby="mobile-projects-button">
          <li role="none"><a href="/projects/buildmc" class="block py-1 hover:text-accent" role="menuitem" tabindex="-1">BuildMC</a></li>
        </ul>
      </li>

      <!-- Plugins -->
      <li>
        <button 
          class="w-full text-left flex justify-between items-center py-2 hover:text-accent transition" 
          data-toggle="plugins"
          aria-expanded="false"
          aria-haspopup="true"
          aria-controls="plugins"
          id="mobile-plugins-button"
        >
          Plugins
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <ul class="hidden pl-4 space-y-1" id="plugins" role="menu" aria-labelledby="mobile-plugins-button">
          <li role="none"><a href="/plugins/de/core" class="block py-1 hover:text-accent" role="menuitem" tabindex="-1">Core</a></li>
        </ul>
      </li>

      <!-- Static -->
      <li><a href="/gallery" class="block py-2 hover:text-accent transition">Gallerie</a></li>
      <li><a href="/team" class="block py-2 hover:text-accent transition">Team</a></li>
    </ul>
  </nav>

  <script>
    // Mobile menu toggle
    const toggleButton = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    if (toggleButton && mobileMenu) {
      toggleButton.addEventListener('click', () => {
        const isOpen = mobileMenu.classList.contains('max-h-[1000px]');
        mobileMenu.classList.toggle('max-h-[1000px]');
        if (!isOpen) {
          mobileMenu.classList.remove('overflow-hidden');
          toggleButton.setAttribute('aria-expanded', 'true');
        } else {
          mobileMenu.classList.add('overflow-hidden');
          toggleButton.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Mobile dropdown toggles
    document.querySelectorAll('[data-toggle]').forEach((btn) => {
      if (!(btn instanceof HTMLButtonElement)) return;

      const id = btn.getAttribute('data-toggle');
      if (!id) return;

      const submenu = document.getElementById(id);
      const icon = btn.querySelector('svg');

      if (!submenu || !icon) return;

      const toggleSubmenu = () => {
        const isHidden = submenu.classList.contains('hidden');
        submenu.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
        btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        
        const menuItems = submenu.querySelectorAll('a[role="menuitem"]');
        if (isHidden) {
          menuItems.forEach(item => item.removeAttribute('tabindex'));
        } else {
          menuItems.forEach(item => item.setAttribute('tabindex', '-1'));
        }
      };

      btn.addEventListener('click', toggleSubmenu);

      btn.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleSubmenu();
        } else if (e.key === 'ArrowDown' && submenu.classList.contains('hidden')) {
          e.preventDefault();
          toggleSubmenu();
          const firstItem = submenu.querySelector<HTMLElement>('a[role="menuitem"]');
          if (firstItem) {
            setTimeout(() => firstItem.focus(), 0);
          }
        }
      });

      const menuItems = submenu.querySelectorAll<HTMLElement>('a[role="menuitem"]');
      menuItems.forEach(item => item.setAttribute('tabindex', '-1'));

      menuItems.forEach((item, index) => {
        item.addEventListener('keydown', (e: KeyboardEvent) => {
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = (index + 1) % menuItems.length;
            menuItems[nextIndex].focus();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (index === 0) {
              btn.focus();
            } else {
              const prevIndex = (index - 1 + menuItems.length) % menuItems.length;
              menuItems[prevIndex].focus();
            }
          } else if (e.key === 'Home') {
            e.preventDefault();
            menuItems[0].focus();
          } else if (e.key === 'End') {
            e.preventDefault();
            menuItems[menuItems.length - 1].focus();
          }
        });
      });
    });
  </script>
  <script>
    const themeToggle = document.getElementById('theme-toggle');
    const themeToggleMobile = document.getElementById('theme-toggle-mobile');
    const root = document.documentElement;

    function toggleTheme() {
      if (root.dataset.theme === 'light') {
        root.removeAttribute('data-theme');
      } else {
        root.dataset.theme = 'light';
      }
    }

    themeToggle?.addEventListener('click', toggleTheme);
    themeToggleMobile?.addEventListener('click', toggleTheme);
  </script>

  <script>
    const dropdowns = document.querySelectorAll<HTMLElement>('.dropdown');

    dropdowns.forEach((dropdown) => {
      const button = dropdown.querySelector<HTMLButtonElement>('button');
      const menu = dropdown.querySelector<HTMLElement>('.dropdown-menu');
      if (!menu || !button) return;

      let timeoutId: number | undefined;

      const closeMenu = () => {
        menu.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
        menu.classList.add('opacity-0', '-translate-y-2', 'pointer-events-none');
        button.setAttribute('aria-expanded', 'false');
        const menuItems = menu.querySelectorAll<HTMLElement>('a[role="menuitem"]');
        menuItems.forEach(item => item.setAttribute('tabindex', '-1'));
      };

      const openMenu = () => {
        // Close all dropdowns
        dropdowns.forEach((otherDropdown) => {
          if (otherDropdown === dropdown) return;
          const otherButton = otherDropdown.querySelector<HTMLButtonElement>('button');
          const otherMenu = otherDropdown.querySelector<HTMLElement>('.dropdown-menu');
          if (otherMenu && otherButton) {
            otherMenu.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
            otherMenu.classList.add('opacity-0', '-translate-y-2', 'pointer-events-none');
            otherButton.setAttribute('aria-expanded', 'false');
            const otherMenuItems = otherMenu.querySelectorAll<HTMLElement>('a[role="menuitem"]');
            otherMenuItems.forEach(item => item.setAttribute('tabindex', '-1'));
          }
        });

        clearTimeout(timeoutId);
        menu.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
        menu.classList.remove('opacity-0', '-translate-y-2', 'pointer-events-none');
        button.setAttribute('aria-expanded', 'true');
        const menuItems = menu.querySelectorAll<HTMLElement>('a[role="menuitem"]');
        menuItems.forEach(item => item.removeAttribute('tabindex'));
      };

      dropdown.addEventListener('mouseenter', openMenu);
      dropdown.addEventListener('mouseleave', () => {
        timeoutId = window.setTimeout(() => {
          if (!dropdown.matches(':focus-within')) {
            closeMenu();
          }
        }, 1000); // 1s delay
      });

      button.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const isOpen = button.getAttribute('aria-expanded') === 'true';
          if (isOpen) {
            closeMenu();
          } else {
            openMenu();
            const firstItem = menu.querySelector<HTMLElement>('a[role="menuitem"]');
            if (firstItem) {
              setTimeout(() => firstItem.focus(), 0);
            }
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          closeMenu();
          button.focus();
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          openMenu();
          const firstItem = menu.querySelector<HTMLElement>('a[role="menuitem"]');
          if (firstItem) {
            setTimeout(() => firstItem.focus(), 0);
          }
        } else if (e.key === 'Tab') {
          const isOpen = button.getAttribute('aria-expanded') === 'true';
          if (isOpen && !e.shiftKey) {
            e.preventDefault();
            const firstItem = menu.querySelector<HTMLElement>('a[role="menuitem"]');
            if (firstItem) {
              firstItem.focus();
            }
          }
        }
      });

      button.addEventListener('focus', () => {
        clearTimeout(timeoutId);
      });

      button.addEventListener('blur', (e) => {
        const relatedTarget = e.relatedTarget as HTMLElement;
        if (!dropdown.contains(relatedTarget)) {
          timeoutId = window.setTimeout(() => {
            if (!dropdown.matches(':focus-within')) {
              closeMenu();
            }
          }, 100);
        }
      });

      // Handle menu item navigation
      const menuItems = menu.querySelectorAll<HTMLElement>('a[role="menuitem"]');
      menuItems.forEach((item, index) => {
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            closeMenu();
            button.focus();
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = (index + 1) % menuItems.length;
            (menuItems[nextIndex] as HTMLElement).focus();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (index === 0) {
              button.focus();
            } else {
              const prevIndex = (index - 1 + menuItems.length) % menuItems.length;
              (menuItems[prevIndex] as HTMLElement).focus();
            }
          } else if (e.key === 'Home') {
            e.preventDefault();
            (menuItems[0] as HTMLElement).focus();
          } else if (e.key === 'End') {
            e.preventDefault();
            (menuItems[menuItems.length - 1] as HTMLElement).focus();
          } else if (e.key === 'Tab' && !e.shiftKey) {
            if (index < menuItems.length - 1) {
              e.preventDefault();
              const nextIndex = (index + 1) % menuItems.length;
              (menuItems[nextIndex] as HTMLElement).focus();
            }
          }
        });

        item.addEventListener('blur', () => {
          timeoutId = window.setTimeout(() => {
            if (!dropdown.matches(':focus-within')) {
              closeMenu();
            }
          }, 100);
        });
      });
    });
  </script>
</header>
